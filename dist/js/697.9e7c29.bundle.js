"use strict";(self.webpackChunkts_vue=self.webpackChunkts_vue||[]).push([[697],{3697:(e,n,t)=>{function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function a(e,n,t){return n&&i(e.prototype,n),t&&i(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}t.d(n,{W:()=>s,Y:()=>c});var c=function(){function e(n){var t=this,i=n.broadcastChannelName,a=void 0===i?"yyh_text":i,c=n.sessionId,s=void 0===c?"yyh_123":c,h=n.originator,d=void 0===h?"local":h;o(this,e),this.sessionId=s,this.originator=d,this.curBroadcas=r(a),this.curBroadcas.onmessage=function(e){t.onMessage(e)},this.handlePageRefreshClose()}return a(e,[{key:"onMessage",value:function(e){var n=e.data;"answer"===n.type&&this.handleSedRemoteSDP(n),"hangup"===n.type&&this.hangup()}},{key:"postMessage",value:function(e){this.curBroadcas.postMessage(e)}},{key:"handlePageRefreshClose",value:function(){var e=this;window.addEventListener("beforeunload",(function(){e.postMessage({data:{event:"mainPageRefresh",eventName:"主页面刷新了"}})})),window.addEventListener("beforeunload",(function(){e.postMessage({data:{event:"mainPageClose",eventName:"主页面关闭了"}})}))}},{key:"handleStreamStop",value:function(){this.peerConnection&&this.peerConnection.getSenders().forEach((function(e){e.track.stop()}))}},{key:"close",value:function(){this.peerConnection&&"closed"!==this.peerConnection.signalingState&&(this.peerConnection.getSenders().forEach((function(e){e.track.stop()})),this.peerConnection.close())}},{key:"unmount",value:function(){this.peerConnection&&(this.peerConnection.getSenders().forEach((function(e){e.track.stop()})),this.peerConnection.close(),this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null,this.peerConnection.oniceconnectionstatechange=null,this.peerConnection=null),this.curBroadcas&&(this.curBroadcas.onmessage=null,this.curBroadcas=null)}},{key:"handleOniceconnectionstatechange",value:function(e){"checking"===this.peerConnection.iceConnectionState?this.onSubscriptionMsg({event:"iceConnectionState",code:"checking",eventName:"检查网络配置"}):"connected"===this.peerConnection.iceConnectionState?this.onSubscriptionMsg({event:"iceConnectionState",code:"connected",eventName:"ICE候选者被交换并成功建立了数据传输通道"}):"disconnected"===this.peerConnection.iceConnectionState&&(this.hangup(),this.onSubscriptionMsg({event:"iceConnectionState",code:"connected",eventName:"ICE接被关闭或由于某种原因断开"}))}},{key:"onSubscriptionMsg",value:function(e){}},{key:"handleCreateNewPerrc",value:function(){var e=this;this.handleStreamStop(),this.peerConnection=new RTCPeerConnection,this.peerConnection.onicecandidate=function(n){return e.onIcecandidate(n)},this.peerConnection.ontrack=function(n){return e.handleOnTrack(n)},this.peerConnection.oniceconnectionstatechange=function(n){return e.handleOniceconnectionstatechange(n)}}},{key:"call",value:function(e){var n=this;return new Promise((function(t,o){n.handleCreateNewPerrc(),n.handleStreamAddPeerConnection(e),n.handleCreateOffer().then((function(e){n.handleLocalDes(e).then((function(){n.handleSendSDP(),t({code:1,message:"发送sdp给远端"})})).catch((function(){o({code:0,message:"存入本地offer失败"})}))})).catch((function(){o({code:0,message:"创建offer失败"})}))}))}},{key:"hangup",value:function(){this.peerConnection&&"closed"!==this.peerConnection.signalingState&&(this.postMessage({type:"hangup"}),this.peerConnection.getSenders().forEach((function(e){e.track.stop()})),this.peerConnection.close())}},{key:"getUserMediaToStream",value:function(e,n){return navigator.mediaDevices.getUserMedia({audio:e,video:n})}},{key:"handleStreamAddPeerConnection",value:function(e){var n=new MediaStream,t=e.getAudioTracks(),o=e.getVideoTracks();t.length&&(n.addTrack(t[0]),this.peerConnection.addTrack(n.getAudioTracks()[0],n)),o.length&&(n.addTrack(o[0]),this.peerConnection.addTrack(n.getVideoTracks()[0],n))}},{key:"handleCreateOffer",value:function(){return this.peerConnection.createOffer()}},{key:"handleLocalDes",value:function(e){return this.peerConnection.setLocalDescription(e)}},{key:"handleSendSDP",value:function(){if("have-local-offer"===this.peerConnection.signalingState){var e={type:this.peerConnection.localDescription.type,sdp:this.peerConnection.localDescription.sdp};this.curBroadcas.postMessage(e)}}},{key:"handleSedRemoteSDP",value:function(e){var n=new RTCSessionDescription(e);return this.peerConnection.setRemoteDescription(n)}},{key:"onIcecandidate",value:function(e){e.candidate&&this.curBroadcas.postMessage({type:"candidate",candidate:JSON.stringify(e.candidate)})}},{key:"handleOnTrack",value:function(e){var n=e.streams[0];this.onSubscriptionMsg({event:"remoteStreams",eventName:"远端视频准备好了",remoteStream:n})}}]),e}(),s=function(){function e(n){var t=this,i=n.broadcastChannelName,a=void 0===i?"yyh_text":i,c=n.sessionId,s=void 0===c?"yyh_123":c,h=n.originator,d=void 0===h?"local":h;o(this,e),this.sessionId=s,this.originator=d,this.curBroadcas=r(a),this.curBroadcas.onmessage=function(e){return t.onMessage(e)},this.handlePageRefreshClose()}return a(e,[{key:"onMessage",value:function(e){var n=e.data;if("offer"===n.type&&(this.handleCreateNewPerrc(),this.onSubscriptionMsg({event:"incomingCall",eventName:"收到新的来电",offer:n})),"candidate"===n.type){var t=new RTCIceCandidate(JSON.parse(e.data.candidate));this.peerConnection.addIceCandidate(t)}"hangup"===n.type&&this.hangup()}},{key:"postMessage",value:function(e){this.curBroadcas.postMessage(e)}},{key:"handleCreateNewPerrc",value:function(){var e=this;this.handleStreamStop(),this.peerConnection=new RTCPeerConnection,this.peerConnection.ontrack=function(n){return e.handleOnTrack(n)},this.peerConnection.oniceconnectionstatechange=function(n){return e.handleOniceconnectionstatechange()}}},{key:"handlePageRefreshClose",value:function(){var e=this;window.addEventListener("beforeunload",(function(){e.postMessage({data:{event:"otherPageRefresh",eventName:"其它页面刷新了"}})})),window.addEventListener("beforeunload",(function(){e.postMessage({data:{event:"otherPageClose",eventName:"其它页面关闭了"}})}))}},{key:"handleStreamStop",value:function(){this.peerConnection&&this.peerConnection.getSenders().forEach((function(e){e.track.stop()}))}},{key:"close",value:function(){this.peerConnection&&"closed"!==this.peerConnection.signalingState&&this.peerConnection&&this.peerConnection.getSenders().forEach((function(e){e.track.stop()}))}},{key:"unmount",value:function(){this.peerConnection&&(this.peerConnection.getSenders().forEach((function(e){e.track.stop()})),this.peerConnection.close(),this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null,this.peerConnection.oniceconnectionstatechange=null,this.peerConnection=null),this.curBroadcas&&(this.curBroadcas.onmessage=null,this.curBroadcas=null)}},{key:"hangup",value:function(){this.peerConnection&&"closed"!==this.peerConnection.signalingState&&(this.postMessage({type:"hangup"}),this.peerConnection.getSenders().forEach((function(e){e.track.stop()})),this.peerConnection.close())}},{key:"handleOniceconnectionstatechange",value:function(){"checking"===this.peerConnection.iceConnectionState?this.onSubscriptionMsg({event:"iceConnectionState",code:"checking",eventName:"检查网络配置"}):"connected"===this.peerConnection.iceConnectionState?this.onSubscriptionMsg({event:"iceConnectionState",code:"connected",eventName:"ICE候选者被交换并成功建立了数据传输通道"}):"disconnected"===this.peerConnection.iceConnectionState&&(this.hangup(),this.onSubscriptionMsg({event:"iceConnectionState",code:"connected",eventName:"ICE接被关闭或由于某种原因断开"}))}},{key:"onSubscriptionMsg",value:function(e){}},{key:"answer",value:function(e,n){var t=this;return new Promise((function(o,i){t.handleStreamAddPeerConnection(n),t.handleSedRemoteSDP(e).then((function(){t.handleCreateAnswer().then((function(e){t.handleLocalDes(e).then((function(){t.handleSendAnswerRemoteMsg(),o({code:1,message:"已发送接听消息给发送端,等待ice确认"})})).catch((function(){i({code:0,message:"本地sdp存储失败"})}))})).catch((function(){i({code:0,message:"创建接听offer失败"})}))})).catch((function(){i({code:0,message:"远端sdp存储失败"})}))}))}},{key:"getUserMediaToStream",value:function(e,n){return navigator.mediaDevices.getUserMedia({audio:e,video:n})}},{key:"handleStreamAddPeerConnection",value:function(e){var n=new MediaStream,t=e.getAudioTracks(),o=e.getVideoTracks();t.length&&(n.addTrack(t[0]),this.peerConnection.addTrack(n.getAudioTracks()[0],n)),o.length&&(n.addTrack(o[0]),this.peerConnection.addTrack(n.getVideoTracks()[0],n))}},{key:"handleSedRemoteSDP",value:function(e){var n=new RTCSessionDescription(e);return this.peerConnection.setRemoteDescription(n)}},{key:"handleCreateAnswer",value:function(){return this.peerConnection.createAnswer()}},{key:"handleLocalDes",value:function(e){return this.peerConnection.setLocalDescription(e)}},{key:"handleSendAnswerRemoteMsg",value:function(){var e={type:this.peerConnection.localDescription.type,sdp:this.peerConnection.localDescription.sdp};console.log("666",e),this.curBroadcas.postMessage(e)}},{key:"handleOnTrack",value:function(e){var n=e.streams[0];this.onSubscriptionMsg({event:"remoteStreams",eventName:"远端视频准备好了",remoteStream:n})}}]),e}();function r(e){return new BroadcastChannel(e)}}}]);