"use strict";(self.webpackChunkts_vue=self.webpackChunkts_vue||[]).push([[196],{7567:(e,n,t)=>{t.r(n),t.d(n,{default:()=>O});var o=t(5393),r=function(e){return(0,o.dD)("data-v-0d1dbfa2"),e=e(),(0,o.Cn)(),e},a=r((function(){return(0,o._)("div",{class:"group_title"},"登录",-1)})),c=r((function(){return(0,o._)("div",{class:"group_title"},"预览",-1)})),i=r((function(){return(0,o._)("div",null,"本地视频",-1)})),s=r((function(){return(0,o._)("video",{id:"localRef",autoplay:"",controls:"",style:{width:"480px",height:"320px"}},null,-1)})),l=r((function(){return(0,o._)("div",null,"远程视频",-1)})),u=r((function(){return(0,o._)("video",{id:"remoteRef",autoplay:"",controls:"",style:{width:"480px",height:"320px"}},null,-1)})),d=r((function(){return(0,o._)("div",{class:"group_title"},"呼叫",-1)})),f=t(5888),m=t(5979),g=t.n(m);function p(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function b(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?p(Object(t),!0).forEach((function(n){h(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):p(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function h(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function v(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}const k=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.registerParams={serverip:"",port:"",url:"",password:"",username:"",ssl:!1},this.UA=null,this.peerConnection=null,this.currSession=null}var n,t;return n=e,t=[{key:"initRegisterParams",value:function(e){g().C&&(g().C.SESSION_EXPIRES=120,g().C.MIN_SESSION_EXPIRES=120),this.registerParams=b(b({},this.registerParams),e),this.callbackList={registerCallback:function(e){console.log("注册回调",e)},addStreamsCallback:function(e){},callRemoteCallback:function(e){}}}},{key:"register",value:function(){var e=this.registerParams,n=e.serverip,t=e.port,o=e.password,r=e.username,a=(e.ssl?"wss://":"ws://")+n+(t?":".concat(t):"")+"/",c={sockets:[new(g().WebSocketInterface)(a)],uri:"sip:".concat(r,"@").concat(n),password:o,authorizationUser:r,sessionTimersExpires:5e3};this.UA=new(g().UA)(c),this.UA.start(),this.UA.on("connected",(function(e){console.log("connected",e)})),this.UA.on("disconnected",(function(e){console.log("disconnected",e)})),this.currentReceiveCall=null,this.currentLocalChat=null,this.uaEvensHanlde()}},{key:"uaEvensHanlde",value:function(){var e=this;this.UA&&(this.UA.on("connecting",(function(){console.log("尝试链接"),e.callbackList.registerCallback({code:"connecting",message:"重连中"})})),this.UA.on("connected",(function(){console.log("连接完毕"),e.callbackList.registerCallback({code:"connected",message:"连接完毕"})})),this.UA.on("unregistered",(function(){console.log("主动取消注册或注册后定期重新注册失败"),e.callbackList.registerCallback({code:"unregistered",message:"重新注册失败"})})),this.UA.on("registrationFailed",(function(){console.log("注册失败"),e.callbackList.registerCallback({code:"registrationFailed",message:"注册失败"})})),this.UA.on("registered",(function(){console.log("注册成功"),e.callbackList.registerCallback({code:"registered",message:"注册成功"})})),this.UA.on("disconnected",(function(){e.callbackList.registerCallback({code:"disconnected",message:"websocket 连接失败"})})),this.UA.on("newMessage",(function(e){console.log("接收和发送消息",e,"消息字段",e.data),"remote"===e.originator||e.originator})),this.UA.on("newDTMF",(function(e){"remote"===e.originator||e.originator})),this.UA.on("newInfo",(function(e){"remote"===e.originator||e.originator})),this.UA.on("newRTCSession",(function(n){var t=n.session,o=n.originator;"remote"===o?e.receiveCall(n):"local"===o&&(e.currentLocalChat=n,t.on("confirmed",(function(){if(t.connection.getRemoteStreams().length>0){var n=t.connection.getRemoteStreams()[0];e.callbackList.addStreamsCallback({code:"accepted",message:"添加远程媒体流",data:{type:"remote",srcObject:n}})}if(t.connection.getLocalStreams().length>0){var o=t.connection.getLocalStreams()[0];e.callbackList.addStreamsCallback({code:"accepted",message:"添加本地媒体流",data:{type:"local",srcObject:o}})}e.handleSetPeerConnection(t.connection),e.currSession=t})))})))}},{key:"unregister",value:function(){this.UA&&this.UA.unregister()}},{key:"sendMessage",value:function(e,n,t,o){if(this.UA){var r=new(g().URI)("sip",e,"atlanta.com",5060);this.UA.sendMessage(r,n,{succeeded:t?t():function(){},failed:o?o():function(){}})}}},{key:"answer",value:function(){this.currentReceiveCall.session.answer({mediaConstraints:{audio:!0,video:!0}})}},{key:"callOut",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{mediaType:0},t=arguments.length>2?arguments[2]:void 0;if(this.UA){var o="sip:".concat(e,"@").concat(this.registerParams.serverip),r=this;console.log("呼叫",o);var a={progress:function(e){console.log("呼叫中"),t&&t({code:"progress",message:"呼叫中",data:e})},failed:function(e){console.log("无法建立",e),r.currentLocalChat=null,t&&t({code:"failed",message:"会话无法建立",data:e})},confirmed:function(e){console.log("已接听",e),t&&t({code:"confirmed",message:"对方已接听"})},ended:function(){r.currentLocalChat=null,console.log("通话结束了"),t&&t({code:"ended",message:"通话已结束"})}},c=n.mediaType||0,i=0===c||1===c,s=0===c||2===c;this.UA.call(o,{eventHandlers:a,mediaConstraints:{audio:i,video:s}})}}},{key:"receiveCall",value:function(e){var n=this;console.log("远程来电",e);var t=e.session.remote_identity.display_name;this.currentReceiveCall={code:"progress",userName:t,session:e.session},e.session.on("accepted",(function(){if(n.currentReceiveCall.code="accepted",e.session.connection.getLocalStreams().length>0){console.log("e.session._connection.getLocalStreams()",e.session._connection.getLocalStreams());var t=e.session.connection.getLocalStreams()[0];n.callbackList.addStreamsCallback({code:"accepted",message:"添加本地媒体流",data:{type:"local",srcObject:t}})}if(e.session.connection.getRemoteStreams().length>0){var o=e.session.connection.getRemoteStreams()[0];n.callbackList.addStreamsCallback({code:"accepted",message:"添加远程媒体流",data:{type:"remote",srcObject:o}})}n.currSession=e.session,n.handleSetPeerConnection(e.session.connection)})),e.session.on("peerconnection",(function(){})),e.session.on("progress",(function(){n.currentReceiveCall.code="progress",n.callbackList.callRemoteCallback({code:"progress",message:"有新的来电",data:{remoteName:t,currSession:e.session}})})),e.session.on("ended",(function(){n.currentReceiveCall=null,n.callbackList.callRemoteCallback({code:"ended",message:"来电已挂断"})})),e.session.on("failed",(function(){n.currentReceiveCall=null,n.callbackList.callRemoteCallback({code:"failed",message:"会话无法建立"})}))}},{key:"desktopSharing",value:function(){var e=this,n=this.peerConnection;navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}).then((function(t){var o=t;e.callbackList.addStreamsCallback({code:"accepted",message:"添加本地媒体流",data:{type:"local",srcObject:o}}),n.getSenders().forEach((function(e){if("video"==e.track.kind){var n=e.replaceTrack(t.getVideoTracks()[0]);console.log(n)}})),t.getVideoTracks()[0].addEventListener("ended",(function(){console.log("屏幕共享结束, 准备切换为本地摄像头"),e.switchLocalCamera(n)}))})).catch((function(){console.log("屏幕共享失败")}))}},{key:"switchLocalCamera",value:function(e){var n=this;navigator.mediaDevices.getUserMedia({audio:{autoGainControl:!0,noiseSuppression:!0,echoCancellation:!0},video:!0}).then((function(t){var o=t;n.callbackList.addStreamsCallback({code:"accepted",message:"添加本地媒体流",data:{type:"local",srcObject:o}}),e.getSenders().forEach((function(e){"video"==e.track.kind&&e.replaceTrack(t.getVideoTracks()[0])}))})).catch((function(e){console.error("切换摄像头失败，失败原因：",e)}))}},{key:"settingsScreenSize",value:function(e){this.peerConnection.getLocalStreams()[0].getVideoTracks()[0].applyConstraints(e).then((function(){console.log("动态改变分辨率")}))}},{key:"hangUp",value:function(){this.currSession.terminate()}},{key:"handleSetPeerConnection",value:function(e){this.peerConnection=e}}],t&&v(n.prototype,t),Object.defineProperty(n,"prototype",{writable:!1}),e}();function y(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function w(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?y(Object(t),!0).forEach((function(n){C(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):y(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function C(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}const S={setup:function(){var e=(0,o.qj)({username:"",password:"",serverip:"",port:"7443",ssl:!0}),n=(0,o.qj)({stream:{config:0,local:"",remote:""},callFrom:{username:"wdtest"}}),t=new k,r={login:function(){t.initRegisterParams(w({},e)),r.bindSipServerCallback(),t.register()},call:function(){t.callOut(n.callFrom.username,{mediaType:n.stream.config},(function(e){}))},bindSipServerCallback:function(){t.callbackList.registerCallback=r.registerCallback,t.callbackList.addStreamsCallback=r.addStreamsCallback,t.callbackList.callRemoteCallback=r.callRemoteCallback},registerCallback:function(e){console.log("注册回调",e)},addStreamsCallback:function(e){console.log("媒体流回调",e),e.code,e.message;var n=e.data;"local"===n.type?(console.log("本地",n.srcObject),document.getElementById("localRef").srcObject=n.srcObject):"remote"===n.type&&(document.getElementById("remoteRef").srcObject=n.srcObject)},hangUp:function(){t.hangUp()},callRemoteCallback:function(e){var n=e.code;switch(console.log("来电回调",e),n){case"progress":f.V.confirm({title:"来电",cancelButtonText:"挂断",confirmButtonText:"接听",message:"您有新的来电"}).then((function(){t.answer()})).catch((function(){e.data.currSession.terminate()}));break;case"failed":f.V.close();break;case"ended":document.getElementById("localRef").srcObject=null,document.getElementById("remoteRef").srcObject=null,f.V.close()}},desktopSharing:function(){t.desktopSharing()},settingsScreenSize:function(e){switch(e){case 0:t.settingsScreenSize({width:{exact:50},height:{exact:50}});break;case 1:t.settingsScreenSize({width:{exact:100},height:{exact:100}});break;case 2:t.settingsScreenSize({width:{min:480},height:{min:320}})}}};return w(w({from:e},(0,o.BK)(n)),r)}},O=(0,t(3744).Z)(S,[["render",function(e,n,t,r,f,m){var g=(0,o.up)("a-input"),p=(0,o.up)("a-form-item"),b=(0,o.up)("a-checkbox"),h=(0,o.up)("a-button"),v=(0,o.up)("a-space"),k=(0,o.up)("a-form"),y=(0,o.up)("a-col"),w=(0,o.up)("a-row"),C=(0,o.up)("van-button"),S=(0,o.up)("van-col"),O=(0,o.up)("van-row"),_=(0,o.up)("van-cell-group"),U=(0,o.up)("van-field");return(0,o.wg)(),(0,o.iD)("div",null,[a,(0,o.Wm)(w,{gutter:10},{default:(0,o.w5)((function(){return[(0,o.Wm)(y,{span:12},{default:(0,o.w5)((function(){return[(0,o.Wm)(k,{model:r.from},{default:(0,o.w5)((function(){return[(0,o.Wm)(p,{label:"用户名",name:"username",rules:[{required:!0,message:"请输入用户名!"}]},{default:(0,o.w5)((function(){return[(0,o.Wm)(g,{value:r.from.username,"onUpdate:value":n[0]||(n[0]=function(e){return r.from.username=e}),placeholder:"请输入用户名"},null,8,["value"])]})),_:1}),(0,o.Wm)(p,{label:"密码",name:"password",rules:[{required:!0,message:"请输入密码!"}]},{default:(0,o.w5)((function(){return[(0,o.Wm)(g,{value:r.from.password,"onUpdate:value":n[1]||(n[1]=function(e){return r.from.password=e}),placeholder:"请输入密码"},null,8,["value"])]})),_:1}),(0,o.Wm)(p,{label:"服务IP",name:"serverip",rules:[{required:!0,message:"请输入服务ip!"}]},{default:(0,o.w5)((function(){return[(0,o.Wm)(g,{value:r.from.serverip,"onUpdate:value":n[2]||(n[2]=function(e){return r.from.serverip=e}),placeholder:"请输入服务ip"},null,8,["value"])]})),_:1}),(0,o.Wm)(p,{label:"端口号",name:"port",rules:[{required:!0,message:"请输入端口!"}]},{default:(0,o.w5)((function(){return[(0,o.Wm)(g,{value:r.from.port,"onUpdate:value":n[3]||(n[3]=function(e){return r.from.port=e}),placeholder:"请输入端口"},null,8,["value"])]})),_:1}),(0,o.Wm)(p,{label:"ssl",name:"ssl",rules:[{required:!0,message:"开启wss!"}]},{default:(0,o.w5)((function(){return[(0,o.Wm)(b,{checked:r.from.ssl,"onUpdate:checked":n[4]||(n[4]=function(e){return r.from.ssl=e})},{default:(0,o.w5)((function(){return[(0,o.Uk)("开启wss")]})),_:1},8,["checked"])]})),_:1}),(0,o.Wm)(p,null,{default:(0,o.w5)((function(){return[(0,o.Wm)(v,null,{default:(0,o.w5)((function(){return[(0,o.Wm)(h,{type:"primary","html-type":"submit",onClick:n[5]||(n[5]=function(n){return e.login()})},{default:(0,o.w5)((function(){return[(0,o.Uk)("登陆")]})),_:1})]})),_:1})]})),_:1})]})),_:1},8,["model"])]})),_:1})]})),_:1}),c,(0,o.Wm)(_,{inset:""},{default:(0,o.w5)((function(){return[(0,o.Wm)(O,null,{default:(0,o.w5)((function(){return[(0,o.Wm)(S,{span:"12"},{default:(0,o.w5)((function(){return[i,s,(0,o._)("div",null,[(0,o.Wm)(C,{type:"primary",onClick:n[6]||(n[6]=function(n){return e.desktopSharing()})},{default:(0,o.w5)((function(){return[(0,o.Uk)("共享桌面")]})),_:1}),(0,o.Wm)(C,{type:"primary",onClick:n[7]||(n[7]=function(n){return e.settingsScreenSize(0)})},{default:(0,o.w5)((function(){return[(0,o.Uk)("设置分辨率50*50")]})),_:1}),(0,o.Wm)(C,{type:"primary",onClick:n[8]||(n[8]=function(n){return e.settingsScreenSize(1)})},{default:(0,o.w5)((function(){return[(0,o.Uk)("设置分辨率100*100")]})),_:1}),(0,o.Wm)(C,{type:"primary",onClick:n[9]||(n[9]=function(n){return e.settingsScreenSize(2)})},{default:(0,o.w5)((function(){return[(0,o.Uk)("还原")]})),_:1})])]})),_:1}),(0,o.Wm)(S,{span:"12"},{default:(0,o.w5)((function(){return[l,u]})),_:1})]})),_:1})]})),_:1}),d,(0,o.Wm)(_,{inset:""},{default:(0,o.w5)((function(){return[(0,o.Wm)(U,{modelValue:e.callFrom.username,"onUpdate:modelValue":n[12]||(n[12]=function(n){return e.callFrom.username=n}),label:"用户名",placeholder:"请输入用户名"},{button:(0,o.w5)((function(){return[(0,o.Wm)(C,{size:"small",type:"primary",onClick:n[10]||(n[10]=(0,o.iM)((function(n){return e.call()}),["stop"]))},{default:(0,o.w5)((function(){return[(0,o.Uk)("呼叫")]})),_:1}),(0,o.Wm)(C,{size:"small",type:"primary",onClick:n[11]||(n[11]=(0,o.iM)((function(n){return e.hangUp()}),["stop"]))},{default:(0,o.w5)((function(){return[(0,o.Uk)("挂断")]})),_:1})]})),_:1},8,["modelValue"])]})),_:1})])}],["__scopeId","data-v-0d1dbfa2"]])}}]);